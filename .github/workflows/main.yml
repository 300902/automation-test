name: Automation Test Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  api-tests:
    runs-on: ubuntu-latest
    steps:
      - name: List cucumber-reports directory
        run: ls -l target/cucumber-reports/
      - name: Check for Cucumber JSON Report
        run: |
          if [ ! -f target/cucumber-reports/api-tests.json ]; then
            echo "Cucumber JSON report not found!"
            exit 1
          fi
    name: API Tests
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
    
    - name: Cache Maven dependencies
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
    
    - name: Install Maven dependencies
      run: mvn clean compile test-compile
    
    - name: Run API Tests and Generate Report
      run: mvn verify -Dtest=ApiTestRunner
      if: always()
    
    - name: Upload API Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: api-test-results
        path: |
          target/cucumber-reports/api/
          target/cucumber-reports/api-tests.json
          target/cucumber-reports/api-tests.xml
          target/surefire-reports/
        retention-days: 30
    
    - name: Upload API Test Logs
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: api-test-logs
        path: |
          target/surefire-reports/
          target/*.log
        retention-days: 7

  ui-tests:
    - name: List cucumber-reports directory
      run: ls -l target/cucumber-reports/

    - name: Check for Cucumber JSON Report
      run: |
        if [ ! -f target/cucumber-reports/ui-tests.json ]; then
          echo "Cucumber JSON report not found!"
          exit 1
        fi
    runs-on: ubuntu-latest
    name: UI Tests
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
    
    - name: Cache Maven dependencies
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
    
    - name: Install Chrome Browser
      run: |
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
    
    - name: Install Maven dependencies
      run: mvn clean compile test-compile
    
    - name: Run UI Tests and Generate Report
      run: mvn verify -Dtest=UiTestRunner
      if: always()
    
    - name: Upload UI Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: ui-test-results
        path: |
          target/cucumber-reports/ui/
          target/cucumber-reports/ui-tests.json
          target/cucumber-reports/ui-tests.xml
          target/surefire-reports/
        retention-days: 30
    
    - name: Upload UI Test Screenshots
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: ui-test-screenshots
        path: |
          target/screenshots/
        retention-days: 7

  full-test-suite:
    - name: List cucumber-reports directory
      run: ls -l target/cucumber-reports/

    - name: Check for Cucumber JSON Report
      run: |
        if [ ! -f target/cucumber-reports/all-tests.json ]; then
          echo "Cucumber JSON report not found!"
          exit 1
        fi
    runs-on: ubuntu-latest
    name: Full Test Suite
    needs: [api-tests, ui-tests]
    if: always()
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
    
    - name: Cache Maven dependencies
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
    
    - name: Install Chrome Browser
      run: |
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
    
    - name: Install Maven dependencies
      run: mvn clean compile test-compile
    
    - name: Run All Tests and Generate Combined Report
      run: mvn verify -Dtest=TestRunner
      if: always()
    
    - name: Download API Test Results
      uses: actions/download-artifact@v4
      if: always()
      with:
        name: api-test-results
        path: artifacts/api/
    
    - name: Download UI Test Results
      uses: actions/download-artifact@v4
      if: always()
      with:
        name: ui-test-results
        path: artifacts/ui/
    
    - name: Upload Combined Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: combined-test-results
        path: |
          target/cucumber-reports/
          target/surefire-reports/
          artifacts/
        retention-days: 30
    
    - name: Publish Test Results
      uses: dorny/test-reporter@v1
      if: always()
      with:
        name: Test Results
        path: 'target/surefire-reports/*.xml'
        reporter: java-junit
    
    - name: Test Summary
      if: always()
      run: |
        echo "## Test Execution Summary" >> $GITHUB_STEP_SUMMARY
        echo "### API Tests" >> $GITHUB_STEP_SUMMARY
        echo "- API test results are available in the artifacts" >> $GITHUB_STEP_SUMMARY
        echo "### UI Tests" >> $GITHUB_STEP_SUMMARY
        echo "- UI test results are available in the artifacts" >> $GITHUB_STEP_SUMMARY
        echo "### Combined Results" >> $GITHUB_STEP_SUMMARY
        echo "- Combined test reports are available in the artifacts" >> $GITHUB_STEP_SUMMARY
        
        if [ -f target/cucumber-reports/Cucumber.json ]; then
          echo "- Cucumber JSON report generated successfully" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ -d target/surefire-reports ]; then
          echo "- JUnit XML reports generated successfully" >> $GITHUB_STEP_SUMMARY
        fi
